<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallery - Dual Image Generator</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 24px;
        }

        header {
            max-width: 1400px;
            margin: 0 auto 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        header h1 {
            color: #00d4ff;
            font-size: 1.5rem;
        }
        header a {
            color: #888;
            text-decoration: none;
            font-size: 0.9rem;
        }
        header a:hover { color: #00d4ff; }

        .gallery-grid {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 12px;
        }

        .gallery-item {
            background: #16213e;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.15s;
        }
        .gallery-item:hover { transform: scale(1.02); }
        .gallery-item img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            display: block;
        }
        .gallery-item-info {
            padding: 8px 10px;
            font-size: 0.75rem;
            color: #888;
        }
        .gallery-item-info .filename {
            color: #aaa;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .gallery-item-info .timestamp {
            margin-top: 2px;
        }

        .empty-state {
            text-align: center;
            color: #666;
            padding: 60px 20px;
            font-size: 1.1rem;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal-overlay img {
            max-width: 90vw;
            max-height: 90vh;
            border-radius: 8px;
            user-select: none;
        }
        .modal-close {
            position: absolute;
            top: 20px;
            right: 24px;
            font-size: 2rem;
            color: #fff;
            cursor: pointer;
            z-index: 1001;
            background: none;
            border: none;
            line-height: 1;
        }
        .modal-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 2.5rem;
            color: #fff;
            cursor: pointer;
            background: none;
            border: none;
            padding: 12px;
            opacity: 0.6;
            transition: opacity 0.15s;
            z-index: 1001;
            user-select: none;
        }
        .modal-nav:hover { opacity: 1; }
        .modal-prev { left: 16px; }
        .modal-next { right: 16px; }
        .modal-info {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #aaa;
            font-size: 0.85rem;
            text-align: center;
            z-index: 1001;
        }
    </style>
</head>
<body>
    <header>
        <h1>Gallery</h1>
        <div style="display:flex;align-items:center;gap:16px;">
            <select id="limit" onchange="loadGallery(true)" style="padding:6px 10px;border:1px solid #333;border-radius:6px;background:#0f0f23;color:#fff;font-size:0.9rem;">
                <option value="100">100 images</option>
                <option value="250">250 images</option>
                <option value="500">500 images</option>
                <option value="1000">1000 images</option>
            </select>
            <a href="/">&larr; Back to Generator</a>
        </div>
    </header>

    <div class="gallery-grid" id="gallery"></div>

    <div class="modal-overlay" id="modal">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <button class="modal-nav modal-prev" onclick="navigateModal(-1)">&lsaquo;</button>
        <img id="modal-img" src="">
        <button class="modal-nav modal-next" onclick="navigateModal(1)">&rsaquo;</button>
        <div class="modal-info" id="modal-info"></div>
    </div>

    <script>
        let images = [];
        let modalIndex = -1;

        function formatTimestamp(iso) {
            const d = new Date(iso);
            return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
        }

        function renderGallery() {
            const container = document.getElementById('gallery');
            if (images.length === 0) {
                container.innerHTML = '<div class="empty-state">No images yet</div>';
                return;
            }
            container.innerHTML = images.map((img, i) =>
                `<div class="gallery-item" onclick="openModal(${i})">
                    <img src="${img.url}" loading="lazy">
                    <div class="gallery-item-info">
                        <div class="filename">${img.filename}</div>
                        <div class="timestamp">${formatTimestamp(img.created)}</div>
                    </div>
                </div>`
            ).join('');
        }

        async function loadGallery(force) {
            try {
                const limit = document.getElementById('limit').value;
                const res = await fetch(`/api/gallery?limit=${limit}`);
                const data = await res.json();
                const changed = force || data.length !== images.length ||
                    (data.length > 0 && data[0].filename !== (images[0] && images[0].filename));
                if (changed) {
                    images = data;
                    renderGallery();
                }
            } catch (e) {
                console.error('Failed to load gallery:', e);
            }
        }

        function openModal(index) {
            modalIndex = index;
            updateModal();
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            modalIndex = -1;
        }

        function navigateModal(direction) {
            if (images.length === 0) return;
            modalIndex = (modalIndex + direction + images.length) % images.length;
            updateModal();
        }

        function updateModal() {
            const img = images[modalIndex];
            if (!img) return;
            document.getElementById('modal-img').src = img.url;
            document.getElementById('modal-info').textContent =
                `${img.filename}  |  ${formatTimestamp(img.created)}  |  ${modalIndex + 1} / ${images.length}`;
        }

        document.addEventListener('keydown', e => {
            if (modalIndex === -1) return;
            if (e.key === 'Escape') closeModal();
            else if (e.key === 'ArrowLeft') navigateModal(-1);
            else if (e.key === 'ArrowRight') navigateModal(1);
        });

        document.getElementById('modal').addEventListener('click', e => {
            if (e.target === document.getElementById('modal')) closeModal();
        });

        loadGallery();
        setInterval(loadGallery, 5000);
    </script>
</body>
</html>
